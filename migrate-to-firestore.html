<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Firestore 마이그레이션</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    .status {
      padding: 20px;
      background: #2a2a2a;
      border-radius: 8px;
      margin: 20px 0;
    }
    .progress {
      width: 100%;
      height: 30px;
      background: #333;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    button {
      padding: 15px 30px;
      font-size: 16px;
      background: #22c55e;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #16a34a;
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .google-btn {
      background: #4285f4;
    }
    .google-btn:hover {
      background: #3367d6;
    }
    .log {
      background: #000;
      padding: 15px;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .log-item { margin: 5px 0; }
    .log-success { color: #22c55e; }
    .log-error { color: #ef4444; }
    .log-info { color: #3b82f6; }
    .warning {
      background: #7c2d12;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .user-info {
      background: #1e3a5f;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>Firestore 데이터 마이그레이션</h1>

  <div class="warning">
    <strong>주의:</strong> 이 스크립트는 JSON 파일의 시계 데이터를 Firestore의 'watches' 컬렉션으로 업로드합니다.
    <br>관리자 계정으로 로그인 후 실행해주세요.
  </div>

  <div class="user-info" id="user-info">
    <div id="login-status">로그인 상태 확인 중...</div>
  </div>

  <div class="status">
    <div id="status-text">준비됨</div>
    <div class="progress">
      <div class="progress-bar" id="progress-bar" style="width: 0%">0%</div>
    </div>
    <div id="count-text">0 / 0</div>
  </div>

  <button class="google-btn" id="login-btn" onclick="loginWithGoogle()" style="display:none;">Google 로그인</button>
  <button id="start-btn" onclick="startMigration()" disabled>마이그레이션 시작</button>
  <button id="check-btn" onclick="checkData()">기존 데이터 확인</button>

  <div class="log" id="log"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyBunJyCChJ4GdpJwjVDrfeS9UTdyTqwssk",
      authDomain: "rolex-reserve.firebaseapp.com",
      projectId: "rolex-reserve",
      storageBucket: "rolex-reserve.firebasestorage.app",
      messagingSenderId: "176619354732",
      appId: "1:176619354732:web:115c50a63584d36353b649"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    const ADMIN_EMAILS = ['lcjun37@gmail.com'];

    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const item = document.createElement('div');
      item.className = `log-item log-${type}`;
      item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(item);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateProgress(current, total) {
      const percent = Math.round((current / total) * 100);
      document.getElementById('progress-bar').style.width = `${percent}%`;
      document.getElementById('progress-bar').textContent = `${percent}%`;
      document.getElementById('count-text').textContent = `${current} / ${total}`;
    }

    // 로그인 상태 확인
    auth.onAuthStateChanged(user => {
      const loginStatus = document.getElementById('login-status');
      const loginBtn = document.getElementById('login-btn');
      const startBtn = document.getElementById('start-btn');

      if (user) {
        const isAdmin = ADMIN_EMAILS.includes(user.email);
        loginStatus.innerHTML = `
          <strong>로그인:</strong> ${user.email}<br>
          <strong>관리자:</strong> ${isAdmin ? '예' : '아니오'}
        `;
        loginBtn.style.display = 'none';
        startBtn.disabled = !isAdmin;
        if (!isAdmin) {
          log('관리자 계정으로 로그인해주세요.', 'error');
        } else {
          log('관리자로 로그인됨. 마이그레이션을 시작할 수 있습니다.', 'success');
        }
      } else {
        loginStatus.textContent = '로그인이 필요합니다.';
        loginBtn.style.display = 'inline-block';
        startBtn.disabled = true;
      }
    });

    async function loginWithGoogle() {
      try {
        await auth.signInWithPopup(googleProvider);
      } catch (error) {
        log(`로그인 실패: ${error.message}`, 'error');
      }
    }

    async function checkData() {
      log('기존 데이터 확인 중...', 'info');

      try {
        // watches 컬렉션 확인
        const watchesSnapshot = await db.collection('watches').limit(10).get();
        log(`watches 컬렉션: ${watchesSnapshot.size}개 문서 (상위 10개 조회)`, 'info');

        if (watchesSnapshot.size > 0) {
          const firstDoc = watchesSnapshot.docs[0];
          log(`샘플 문서 ID: ${firstDoc.id}`, 'info');
        }

        // 전체 개수 확인 (시간이 걸릴 수 있음)
        log('전체 개수 확인 중... (시간이 걸릴 수 있습니다)', 'info');
        const allWatches = await db.collection('watches').get();
        log(`watches 전체: ${allWatches.size}개`, 'success');

        // watchStatus 컬렉션 확인
        const statusSnapshot = await db.collection('watchStatus').get();
        log(`watchStatus 컬렉션: ${statusSnapshot.size}개 오버라이드`, 'info');

      } catch (error) {
        log(`오류: ${error.message}`, 'error');
      }
    }

    async function startMigration() {
      const btn = document.getElementById('start-btn');
      btn.disabled = true;
      document.getElementById('status-text').textContent = '마이그레이션 진행 중...';

      try {
        // 1. JSON 파일 로드
        log('JSON 파일 로드 중...', 'info');
        const response = await fetch('rolex_watches.json');
        const watches = await response.json();
        log(`${watches.length}개 시계 데이터 로드 완료`, 'success');

        // 2. 기존 watchStatus 오버라이드 로드
        log('기존 상태 오버라이드 로드 중...', 'info');
        const statusSnapshot = await db.collection('watchStatus').get();
        const statusOverrides = {};
        statusSnapshot.forEach(doc => {
          statusOverrides[doc.id] = doc.data().status;
        });
        log(`${Object.keys(statusOverrides).length}개 상태 오버라이드 로드 완료`, 'success');

        // 3. Firestore에 배치 업로드 (500개씩)
        log('Firestore 업로드 시작...', 'info');
        const batchSize = 450;
        let uploaded = 0;
        let errors = 0;

        for (let i = 0; i < watches.length; i += batchSize) {
          const batch = db.batch();
          const chunk = watches.slice(i, i + batchSize);

          chunk.forEach(watch => {
            // 오버라이드가 있으면 적용
            const finalStatus = statusOverrides[watch.model_number] || watch.buy_status;

            const docRef = db.collection('watches').doc(watch.model_number);
            batch.set(docRef, {
              ...watch,
              buy_status: finalStatus,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          });

          try {
            await batch.commit();
            uploaded += chunk.length;
            updateProgress(uploaded, watches.length);
            log(`${uploaded}개 업로드 완료`, 'success');
          } catch (error) {
            log(`배치 오류: ${error.message}`, 'error');
            errors += chunk.length;
          }
        }

        document.getElementById('status-text').textContent = '마이그레이션 완료!';
        log(`완료! 성공: ${uploaded}개, 실패: ${errors}개`, 'success');

      } catch (error) {
        log(`오류 발생: ${error.message}`, 'error');
        document.getElementById('status-text').textContent = '오류 발생';
      }

      btn.disabled = false;
    }
  </script>
</body>
</html>
